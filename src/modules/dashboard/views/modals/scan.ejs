<div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" id="scan-modal">
  <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center relative">
    
    <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>

    <h3 class="text-xl font-bold mb-4 text-gray-800">Scan QR Code</h3>
    
    <div id="qr-container" class="mb-4 flex justify-center items-center h-64 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
      <div class="text-gray-400 animate-pulse text-sm" id="qr-loading">
        Connecting to server...<br>Please wait...
      </div>
      <img id="qr-image" class="hidden w-60 h-60 object-contain" alt="Scan Me" />
    </div>

    <div id="status-text" class="text-sm font-medium text-gray-600 mb-4">
      Waiting for QR Code...
    </div>

    <p class="text-xs text-gray-500">
      Open WhatsApp on your phone > Menu > Linked Devices > Link a Device
    </p>
  </div>

  <script>
    // Self-executing function scope to prevent variable leakage
    (function() {
      const tenantId = '<%= tenantId %>';
      const apiKey = '<%= apiKey %>';
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/public/tenants/${tenantId}/ws?apiKey=${apiKey}`;
      
      const statusText = document.getElementById('status-text');
      const qrImage = document.getElementById('qr-image');
      const qrLoading = document.getElementById('qr-loading');
      
      // Init WebSocket
      const ws = new WebSocket(wsUrl);

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === 'qr') {
          // Show QR
          qrLoading.classList.add('hidden');
          qrImage.src = msg.data;
          qrImage.classList.remove('hidden');
          statusText.innerText = "Scan this QR Code now!";
          statusText.className = "text-sm font-medium text-blue-600 mb-4 animate-pulse";
        } 
        else if (msg.type === 'ready') {
          // Login Successful
          qrImage.classList.add('hidden');
          qrLoading.classList.add('hidden');
          
          statusText.innerHTML = `
            <span class="text-green-600 flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
              Connected! Refreshing...
            </span>
          `;
          
          // close modal and refresh page after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);
          
          ws.close();
        }
      };

      ws.onclose = () => {
        console.log('WS Disconnected');
      };
      
      // Expose close function globally just for this modal instance
      window.closeModal = function() {
        ws.close();
        document.getElementById('modal-container').innerHTML = ''; // Remove modal from DOM
      }
    })();
  </script>
</div>
